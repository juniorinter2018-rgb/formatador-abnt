<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatador ABNT - Editor Paginado</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; margin: 0; padding: 20px 0; }
        .container { max-width: 1200px; margin: auto; }
        .config-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2 { color: #2c3e50; text-align: center; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; display: block; width: 100%; margin-top: 20px; }
        button:hover { background-color: #2980b9; }

        .document-editor { padding: 40px; }
        .page {
            background: white;
            width: 21cm;
            height: 29.7cm; /* Altura FIXA de uma folha A4 */
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            padding: 3cm 2cm 2cm 3cm; /* Margens ABNT */
            box-sizing: border-box;
            position: relative;
        }
        .editor-instance { height: 100%; }
        .ql-container.ql-snow { border: none !important; font-size: 12pt; font-family: 'Arial', sans-serif; }
        .ql-editor { line-height: 1.5; height: 100%; padding: 0; overflow-y: hidden; }
        .ql-editor.ql-blank::before{ content: 'Comece a escrever aqui...'; font-style: normal; color: #aaa; position: absolute; }
        .ql-editor h1 { font-weight: bold; text-transform: uppercase; }
        .ql-editor h2 { font-weight: bold; }
        .ql-editor .ql-indent-1 { padding-left: 4cm; font-size: 10pt; line-height: 1.0; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input[type="text"], select { width: 98%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc;}
        .referencia { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        #btnAdicionar { background-color: #2ecc71; margin-bottom: 20px; width: auto; padding: 10px 15px; font-size: 0.9em; display: inline-block;}
        .campos-especificos { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="config-panel">
            <h1>Formatador ABNT</h1>
            <h2>Painel de Controlo</h2>
            <div class="grid-container">
                 <input type="text" id="info_autor" placeholder="Nome(s) do(s) Autor(es)">
                <input type="text" id="info_titulo" placeholder="Título do Trabalho">
                <input type="text" id="info_subtitulo" placeholder="Subtítulo (se houver)">
                <input type="text" id="info_instituicao" placeholder="Nome da Instituição">
                <input type="text" id="info_curso" placeholder="Nome do Curso">
                <input type="text" id="info_cidade" placeholder="Cidade">
                <input type="text" id="info_ano" placeholder="Ano de Entrega">
                <input type="text" id="info_orientador" placeholder="Nome do Orientador">
            </div>
            <h2 style="margin-top: 30px;">Referências Bibliográficas</h2>
            <div id="referenciasContainer">
                <div class="referencia">
                    <select class="tipo-referencia"><option value="livro" selected>Livro</option><option value="site">Site</option><option value="artigo">Artigo</option></select>
                    <input type="text" class="autor" placeholder="Autor (Ex: SILVA, João)"><input type="text" class="titulo" placeholder="Título"><input type="text" class="ano" placeholder="Ano">
                    <div class="campos-especificos campos-livro" style="display: block;"><input type="text" class="cidade" placeholder="Cidade"><input type="text" class="editora" placeholder="Editora"></div>
                    <div class="campos-especificos campos-site"><input type="text" class="nome_site" placeholder="Nome do Site"><input type="text" class="url" placeholder="URL"><input type="text" class="data_acesso" placeholder="Data de Acesso"></div>
                    <div class="campos-especificos campos-artigo"><input type="text" class="nome_revista" placeholder="Nome da Revista"><input type="text" class="volume" placeholder="Volume"><input type="text" class="numero" placeholder="Número"><input type="text" class="paginas" placeholder="Páginas"></div>
                </div>
            </div>
            <button id="btnAdicionar">Adicionar Referência</button>
            <button id="btnFormatar">Formatar e Baixar .DOCX</button>
        </div>
        <div id="document-container" class="document-editor">
            </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const pageContentHeight = (29.7 - 3 - 2) * 37.795; // Altura útil da página em pixels
        const editors = [];
        const documentContainer = document.getElementById('document-container');
        let isPaginating = false;
        const Delta = Quill.import('delta');

        function createNewPage(initialContent = null) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            
            const editorDiv = document.createElement('div');
            editorDiv.className = 'editor-instance';
            
            pageDiv.appendChild(editorDiv);
            documentContainer.appendChild(pageDiv);

            const quill = new Quill(editorDiv, {
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic'],
                        ['blockquote']
                    ]
                },
                theme: 'snow'
            });

            quill.on('text-change', (delta, oldDelta, source) => {
                if (source === 'user' && !isPaginating) {
                    const activeEditorIndex = editors.indexOf(quill);
                    if(activeEditorIndex !== -1) {
                       checkAndPaginate(activeEditorIndex);
                    }
                }
            });
            
            if(initialContent) {
                quill.setContents(initialContent, 'silent');
            }
            editors.push(quill);
            return quill;
        }
        
        function checkAndPaginate(startIndex) {
            if(isPaginating) return;
            isPaginating = true;
        
            let currentPageIndex = startIndex;
            let needsRepagination = false;
        
            // Verifica se alguma paginação é necessária
            for(let i = startIndex; i < editors.length; i++) {
                if(editors[i].root.scrollHeight > pageContentHeight) {
                    needsRepagination = true;
                    break;
                }
            }
        
            if (!needsRepagination) {
                isPaginating = false;
                return;
            }
        
            // Lógica de repaginação
            const selection = getGlobalSelection();
        
            let fullContent = new Delta();
            for(let i = 0; i < editors.length; i++) {
                fullContent = fullContent.concat(editors[i].getContents());
            }
        
            documentContainer.innerHTML = '';
            editors.length = 0;
        
            const firstEditor = createNewPage();
            firstEditor.setContents(fullContent, 'silent');
        
            let currentEditor = firstEditor;
            while(currentEditor.root.scrollHeight > pageContentHeight) {
                const lines = currentEditor.getLines();
                let splitBlot = null;
                let currentHeight = 0;
        
                for (const line of lines) {
                    currentHeight += line.domNode.offsetHeight;
                    if (currentHeight > pageContentHeight) {
                        splitBlot = line;
                        break;
                    }
                }
        
                if (splitBlot) {
                    const splitIndex = currentEditor.getIndex(splitBlot);
                    const overflowContent = currentEditor.getContents(splitIndex);
                    currentEditor.deleteText(splitIndex, currentEditor.getLength(), 'silent');
                    
                    const nextEditor = createNewPage();
                    nextEditor.setContents(overflowContent, 'silent');
                    currentEditor = nextEditor;
                } else {
                    break;
                }
            }
        
            if (selection !== null) {
                setGlobalSelection(selection);
            }
            
            isPaginating = false;
        }

        // --- Funções de Seleção e Lógica do Formulário (sem alterações) ---
        function getGlobalSelection() {
            let absoluteIndex = 0;
            for (const editor of editors) {
                const selection = editor.getSelection();
                if (selection) { return absoluteIndex + selection.index; }
                absoluteIndex += editor.getLength() > 1 ? editor.getLength() - 1 : 0;
            }
            return null;
        }

        function setGlobalSelection(absoluteIndex) {
            let currentLength = 0;
            for (const editor of editors) {
                const editorLength = editor.getLength() > 1 ? editor.getLength() - 1 : 0;
                if (absoluteIndex <= currentLength + editorLength) {
                    const relativeIndex = absoluteIndex - currentLength;
                    editor.setSelection(relativeIndex, 0, 'silent');
                    editor.focus();
                    return;
                }
                currentLength += editorLength;
            }
             if(editors.length > 0) {
                const lastEditor = editors[editors.length - 1];
                lastEditor.focus();
                lastEditor.setSelection(lastEditor.getLength() - 1, 0, 'silent');
            }
        }
        
        createNewPage();

        document.getElementById('btnFormatar').addEventListener('click', async function() {
            this.innerText = 'Formatando...'; this.disabled = true;
            const info_trabalho = {autor: document.getElementById('info_autor').value, titulo: document.getElementById('info_titulo').value, subtitulo: document.getElementById('info_subtitulo').value, instituicao: document.getElementById('info_instituicao').value, curso: document.getElementById('info_curso').value, cidade: document.getElementById('info_cidade').value, ano: document.getElementById('info_ano').value, orientador: document.getElementById('info_orientador').value};
            const referencias = [];
            document.querySelectorAll('.referencia').forEach(bloco => {
                const autor = bloco.querySelector('.autor').value; if (!autor) return;
                const tipo = bloco.querySelector('.tipo-referencia').value; const referencia = { tipo: tipo, autor: autor, titulo: bloco.querySelector('.titulo').value, ano: bloco.querySelector('.ano').value };
                if (tipo === 'livro') { referencia.cidade = bloco.querySelector('.cidade').value; referencia.editora = bloco.querySelector('.editora').value; } 
                else if (tipo === 'site') { referencia.nome_site = bloco.querySelector('.nome_site').value; referencia.url = bloco.querySelector('.url').value; referencia.data_acesso = bloco.querySelector('.data_acesso').value; } 
                else if (tipo === 'artigo') { referencia.nome_revista = bloco.querySelector('.nome_revista').value; referencia.volume = bloco.querySelector('.volume').value; referencia.numero = bloco.querySelector('.numero').value; referencia.paginas = bloco.querySelector('.paginas').value; }
                referencias.push(referencia);
            });
            let fullText = '';
            editors.forEach(editor => {
                fullText += editor.getText();
            });

            // Lógica de conversão para o backend precisa ser ajustada para o novo sistema
            let textoParaBackend = '';
            const fullContent = editors.reduce((delta, editor) => delta.concat(editor.getContents()), new Delta());
            fullContent.ops.forEach(op => {
                if (typeof op.insert === 'string') {
                    const lines = op.insert.split('\n');
                    lines.forEach((line, index) => {
                        if (line) {
                           const attrs = op.attributes || {};
                           if (attrs.header) { textoParaBackend += `${'#'.repeat(attrs.header)} ${line}\n\n`; }
                           else if (attrs.blockquote) { textoParaBackend += `[clonga]${line}[fimclonga]\n\n`; }
                           else { textoParaBackend += `${line}\n\n`; }
                        }
                    });
                }
            });
            
            const dadosParaEnviar = { info_trabalho, texto: textoParaBackend.trim(), referencias };
            try {
                const response = await fetch('http://127.0.0.1:5000/formatar', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosParaEnviar)
                });
                if (response.ok) {
                    const blob = await response.blob(); const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'trabalho_formatado.docx';
                    document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
                } else {
                    alert("Ocorreu um erro ao formatar o documento."); console.error("Erro do servidor:", await response.text());
                }
            } catch (error) {
                console.error('Erro de rede:', error);
                alert("Não foi possível conectar ao servidor.");
            } finally {
                this.innerText = 'Formatar e Baixar .DOCX'; this.disabled = false;
            }
        });
        function configurarLogicaReferencia(bloco) { /* ... */ }
        document.querySelectorAll('.referencia').forEach(configurarLogicaReferencia);
        document.getElementById('btnAdicionar').addEventListener('click', function() { /* ... */ });
    </script>
</body>
</html>